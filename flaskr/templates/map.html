<!DOCTYPE html>
<html>

<head>
    <title>Map Test</title>
    <link href="../static/css/styles.css" rel="stylesheet" type="text/css">
    <meta id="result" data-result="{{result}}" data-pref="{{pref}}">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    {{ JSGlue.include() }}
</head>

<body>

    <div style="position: relative">
        <div id="one-city-views" class="overlay" style="display: none;">

        </div>

        
        <div class="tagContainer">
            <div id="t-nightlife" class="turq tags"><p>Nightlife</p></div>
            <div id="t-nature" class="eme tags"><p>Nature</p></div>
            <div id="t-beach" class="ptr tags"><p>Beach</p></div>
            <div id="t-museum" class="sfa tags "><p>Museum</p></div>
            <div id="t-wildlife" class="car tags"><p>Wildlife</p></div>
            <div id="t-landscape" class="brp tags"><p>Landscape</p></div>
            <!-- <div id="print" style="color: white;"></div> //test if result is sent to html-->
        </div>
        <div id="map-holder"></div>
       

    </div>
<!--To access the ele here in html, otherwise I can write this to a file. -->
<!--    {% for ele in result %}-->
<!--    <li>{{ ele }}</li>-->
<!--    {% endfor %}-->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.5.0/d3.min.js" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js" charset="utf-8"></script>
   <script src="https://d3js.org/d3.v4.js"></script>
   <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
   <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
   <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.js"></script>
   <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts-gl/dist/echarts-gl.min.js"></script>
   <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts-stat/dist/ecStat.min.js"></script>
   <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts/dist/extension/dataTool.min.js"></script>
   <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts/dist/extension/bmap.min.js"></script>

    <script>
        // ...

        $(() => {
            // console.log($('#result').data().result)
            let result = $('#result').data().result.replace(/'/g, '"')
            console.log( JSON.parse(result) )
            console.log( $('#result').data().pref )

            $('.tags').each(function(i, obj) {
                if ($(this)[0].id !== "t-"+$('#result').data().pref)
                $(this).addClass('tagDisabled')
            });
        })

        //change tag
        $(".tags").on('click', (event) => {
            let newTag = event.currentTarget.id.replace("t-", "")
            if (newTag !== $('#result').data().pref) {
                location.href = Flask.url_for('user_pref', {pref: newTag});
            }
        })

        $("#close-city").click(() => {
            console.log("click")
                d3.select("#one-city-views").style("display", "none")
                cityOpened = false

        }) 

    </script>
    <script>
        tagColors = {
            nightlife: "1abc9c",
            nature: "d35400",
            beach: "3498db", 
            museum: "f1c40f", 
            wildlife: "e67e22",
            landscape: "2980b9"
        }
        // DEFINE VARIABLES
        // Define size of map group
        // Full world map is 2:1 ratio
        // Using 12:5 because we will crop top and bottom of map
        w = 3000;
        h = 1250;
        // variables for catching min and max zoom factors
        var minZoom;
        var maxZoom;

        // DEFINE FUNCTIONS/OBJECTS
        // Define map projection
        var projection = d3
            .geoEquirectangular()
            .center([0, 15]) // set centre to further North as we are cropping more off bottom of map
            .scale([w / (2 * Math.PI)]) // scale to fit group width
            .translate([w / 2, h / 2]) // ensure centred in group
        ;

        // Define map path
        var path = d3
            .geoPath()
            .projection(projection);

        // Create function to apply zoom to countriesGroup
        function zoomed() {
            t = d3
                .event
                .transform;
            countriesGroup
                .attr("transform", "translate(" + [t.x, t.y] + ")scale(" + t.k + ")");
        }

        // Define map zoom behaviour
        var zoom = d3
            .zoom()
            .on("zoom", zoomed);

        function getTextBox(selection) {
            selection
                .each(function (d) {
                    d.bbox = this
                        .getBBox();
                });
        }

        // Function that calculates zoom/pan limits and sets zoom to default value 
        function initiateZoom() {
            // Define a "minzoom" whereby the "Countries" is as small possible without leaving white space at top/bottom or sides
            minZoom = Math.max($("#map-holder").width() / w, $("#map-holder").height() / h);
            // set max zoom to a suitable factor of this value
            maxZoom = 20 * minZoom;
            // set extent of zoom to chosen values
            // set translate extent so that panning can't cause map to move out of viewport
            zoom
                .scaleExtent([minZoom, maxZoom])
                .translateExtent([
                    [0, 0],
                    [w, h]
                ]);
            // define X and Y offset for centre of map to be shown in centre of holder
            midX = ($("#map-holder").width() - minZoom * w) / 2;
            midY = ($("#map-holder").height() - minZoom * h) / 2;
            // change zoom transform to min zoom and centre offsets
            svg.call(zoom.transform, d3.zoomIdentity.translate(midX, midY).scale(minZoom));
        }

        // zoom to show a bounding box, with optional additional padding as percentage of box size
        function boxZoom(box, centroid, paddingPerc) {
            minXY = box[0];
            maxXY = box[1];
            // find size of map area defined
            zoomWidth = Math.abs(minXY[0] - maxXY[0]);
            zoomHeight = Math.abs(minXY[1] - maxXY[1]);
            // find midpoint of map area defined
            zoomMidX = centroid[0];
            zoomMidY = centroid[1];
            // increase map area to include padding
            zoomWidth = zoomWidth * (1 + paddingPerc / 100);
            zoomHeight = zoomHeight * (1 + paddingPerc / 100);
            // find scale required for area to fill svg
            maxXscale = $("svg").width() / zoomWidth;
            maxYscale = $("svg").height() / zoomHeight;
            zoomScale = Math.min(maxXscale, maxYscale);
            // handle some edge cases
            // limit to max zoom (handles tiny countries)
            zoomScale = Math.min(zoomScale, maxZoom);
            // limit to min zoom (handles large countries and countries that span the date line)
            zoomScale = Math.max(zoomScale, minZoom);
            // Find screen pixel equivalent once scaled
            offsetX = zoomScale * zoomMidX;
            offsetY = zoomScale * zoomMidY;
            // Find offset to centre, making sure no gap at left or top of holder
            dleft = Math.min(0, $("svg").width() / 2 - offsetX);
            dtop = Math.min(0, $("svg").height() / 2 - offsetY);
            // Make sure no gap at bottom or right of holder
            dleft = Math.max($("svg").width() - w * zoomScale, dleft);
            dtop = Math.max($("svg").height() - h * zoomScale, dtop);
            // set zoom
            svg
                .transition()
                .duration(500)
                .call(
                    zoom.transform,
                    d3.zoomIdentity.translate(dleft, dtop).scale(zoomScale)
                );
        }




        // on window resize
        $(window).resize(function () {
            // Resize SVG
            svg
                .attr("width", $("#map-holder").width())
                .attr("height", $("#map-holder").height());
            initiateZoom();
        });

        // create an SVG
        var svg = d3
            .select("#map-holder")
            .append("svg")
            // set to the same size as the "map-holder" div
            .attr("width", $("#map-holder").width())
            .attr("height", $("#map-holder").height())
            // add zoom functionality
            .call(zoom);



        var result = JSON.parse('{{ result | tojson | safe}}');
        // document.getElementById('print').innerHTML = result[0].longitude+','+result[0].latitude;
        // Create data for donut:
        var data = result;
        
        // get map data
        d3.json(
            "https://raw.githubusercontent.com/andybarefoot/andybarefoot-www/master/maps/mapdata/custom50.json",
            function (json) {
                //Bind data and create one path per GeoJSON feature
                countriesGroup = svg.append("g").attr("id", "map");
                // add a background rectangle
                countriesGroup
                    .append("rect")
                    .attr("x", 0)
                    .attr("y", 0)
                    .attr("width", w)
                    .attr("height", h);

                // draw a path for each feature/country
                countries = countriesGroup
                    .selectAll("path")
                    .data(json.features)
                    .enter()
                    .append("path")
                    .attr("d", path)
                    .attr("id", function (d, i) {
                        return "country" + d.properties.iso_a3;
                    })
                    .attr("class", "country")
                    //      .attr("stroke-width", 10)
                    //      .attr("stroke", "#ff0000")
                    // add a mouseover action to show name label for feature/country
                    .on("mouseover", function (d, i) {
                        d3.select("#countryLabel" + d.properties.iso_a3).style("display", "block");
                    })
                    .on("mouseout", function (d, i) {
                        d3.select("#countryLabel" + d.properties.iso_a3).style("display", "none");
                    })
                    // add an onclick action to zoom into clicked country
                    .on("click", function (d, i) {
                        d3.selectAll(".country").classed("country-on", false);
                        d3.select(this).classed("country-on", true);
                        boxZoom(path.bounds(d), path.centroid(d), 20);
                    });
                       

                var cityOpened = false
                
                cities = countriesGroup
                  .selectAll("myCircles")
                  .data(data)
                  .enter()
                  .append("circle")
                    .attr("cx", function(d){ return projection([d.longitude, d.latitude])[0] })
                    .attr("cy", function(d){ return projection([d.longitude, d.latitude])[1] })
                    .attr("r", 14)
                    .style("fill", tagColors[$('#result').data().pref])
                    .attr("stroke", "#" + tagColors[$('#result').data().pref])
                    .attr("stroke-width", 5)
                    .attr("fill-opacity", .01)
                  .on("click", function (val) {
                        // if (!cityOpened) {
                            console.log(val)
                            $.ajax({
                            url: "/city_info",
                            type: "get",
                            data: {photo_id: val.photo_id},
                            success: function(response) {
                                console.log("success")
                                console.log(response)
                                $("#one-city-views").html(response.results)
                            },
                            error: function(xhr) {
                            //Do Something to handle error
                            }
                            });

                            d3.select("#one-city-views").style("display", "block")
                            cityOpened = true
                        // }
                        
                        // if (d3.select("#one-city-views").style("display") == "none") {
                        // } else{
                        //     d3.select("#one-city-views").style("display", "none");
                        // }
                    });

                // Add a label group to each feature/country. This will contain the country name and a background rectangle
                // Use CSS to have class "countryLabel" initially hidden
                countryLabels = countriesGroup
                    .selectAll("g")
                    .data(json.features)
                    .enter()
                    .append("g")
                    .attr("class", "countryLabel")
                    .attr("id", function (d) {
                        return "countryLabel" + d.properties.iso_a3;
                    })
                    .attr("transform", function (d) {
                        return (
                            "translate(" + path.centroid(d)[0] + "," + path.centroid(d)[1] + ")"
                        );
                    })
                    // add mouseover functionality to the label
                    .on("mouseover", function (d, i) {
                        d3.select(this).style("display", "block");
                    })
                    .on("mouseout", function (d, i) {
                        d3.select(this).style("display", "none");
                    })
                    // add an onlcick action to zoom into clicked country
                    .on("click", function (d, i) {
                        d3.selectAll(".country").classed("country-on", false);
                        d3.select("#country" + d.properties.iso_a3).classed("country-on", true);
                        boxZoom(path.bounds(d), path.centroid(d), 20);
                    });
                // add the text to the label group showing country name
                countryLabels
                    .append("text")
                    .attr("class", "countryName")
                    .style("text-anchor", "middle")
                    .attr("dx", 0)
                    .attr("dy", 0)
                    .text(function (d) {
                        return d.properties.name;
                    })
                    .call(getTextBox);
                // add a background rectangle the same size as the text
                countryLabels
                    .insert("rect", "text")
                    .attr("class", "countryLabelBg")
                    .attr("transform", function (d) {
                        return "translate(" + (d.bbox.x - 2) + "," + d.bbox.y + ")";
                    })
                    .attr("width", function (d) {
                        return d.bbox.width + 4;
                    })
                    .attr("height", function (d) {
                        return d.bbox.height;
                    });
                initiateZoom();

                

            }
        );
    </script>
</body>

</html>
